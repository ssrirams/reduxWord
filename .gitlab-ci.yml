image: node:18

stages:
  - install
  - test
  - lint
  - build
  - security
  - deploy

include:
  - template: Security/SAST.gitlab-ci.yml


# Install Node modules and Java
install_dependencies:
  stage: install
  script:
    - echo "Installing dependencies..."
    - apt-get update && apt-get install -y openjdk-17-jdk
    - npm install
  cache:
    paths:
      - node_modules/

lint:
  stage: lint
  script:
    - echo "Running ESLint..."
    - npm install
    - npx eslint .


# Run tests
test:
  stage: test
  script:
    - echo "Running tests..."
    - npm install
    - npm test
  cache:
    paths:
      - node_modules/

# Build Android APK
variables:
  ANDROID_SDK_ROOT: "/sdk"
  ANDROID_HOME: "/sdk"
  JAVA_HOME: "/usr/lib/jvm/java-17-openjdk-amd64"

build_android:
  stage: build
  before_script:
    - apt-get update && apt-get install -y openjdk-17-jdk wget unzip
    - export JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64
    - mkdir -p /sdk
    - export ANDROID_SDK_ROOT=/sdk
    - export ANDROID_HOME=/sdk
    - wget https://dl.google.com/android/repository/commandlinetools-linux-10406996_latest.zip -O cmdline-tools.zip
    - unzip -q cmdline-tools.zip -d /sdk/tmp-tools
    - mkdir -p /sdk/cmdline-tools/latest
    - mv /sdk/tmp-tools/cmdline-tools/* /sdk/cmdline-tools/latest/
    # Accept licenses non-interactively
    - yes | /sdk/cmdline-tools/latest/bin/sdkmanager --sdk_root=/sdk --licenses || true
    - /sdk/cmdline-tools/latest/bin/sdkmanager --sdk_root=/sdk "platform-tools" "platforms;android-33" "build-tools;33.0.2"
    - ls -la android/ || echo "Android directory not found"
    - chmod +x android/gradlew || { echo "Failed to set permissions on gradlew"; exit 1; }
  script:
    - export ANDROID_SDK_ROOT=/sdk
    - export ANDROID_HOME=/sdk
    - npm install
    - cd android
    - ./gradlew --info assembleRelease
    - test -f app/build/outputs/apk/release/app-release.apk && echo "✅ APK built successfully!" || { echo "❌ APK build failed"; exit 1; }
  artifacts:
    paths:
      - android/app/build/outputs/apk/release/app-release.apk
  only:
    - main
  cache:
    paths:
      - node_modules/
      - android/.gradle/
  dependencies:
    - install_dependencies

# Deploy APK for easy download
# pages:
#   stage: deploy
#   script:
#     - mkdir -p public/downloads
#     - cp android/app/build/outputs/apk/release/app-release.apk public/downloads/app-release.apk || echo "Failed to copy APK file. Checking if file exists..." && ls -la android/app/build/outputs/apk/release/
#     - |
#       cat > public/index.html << 'EOL'
#       <!DOCTYPE html>
#       <html>
#         <head>
#           <meta charset="UTF-8">
#           <title>App Downloads</title>
#           <style>
#             body {
#               font-family: Arial, sans-serif;
#               max-width: 800px;
#               margin: 0 auto;
#               padding: 20px;
#             }
#             .download-btn {
#               display: inline-block;
#               background: #4CAF50;
#               color: white;
#               padding: 10px 20px;
#               text-decoration: none;
#               border-radius: 4px;
#             }
#           </style>
#         </head>
#         <body>
#           <h1>App Downloads</h1>
#           <p><a class="download-btn" href="downloads/app-release.apk">Download Android APK</a></p>
#           <p>Last updated: $(date)</p>
#         </body>
#       </html>
#       EOL
#   artifacts:
#     paths:
#       - public
#     expire_in: 30 days
#   only:
#     - main
#   dependencies:
#     - build_android
#   needs:
#     - build_android
pages:
  stage: deploy
  script:
    - mkdir -p public/downloads
    - cp android/app/build/outputs/apk/release/app-release.apk public/downloads/app-release.apk || echo "Failed to copy APK file. Checking if file exists..." && ls -la android/app/build/outputs/apk/release/
    - |
      cat > public/index.html << 'EOL'
      <!DOCTYPE html>
      <html>
        <head>
          <meta charset="UTF-8">
          <title>App Downloads</title>
          <style>
            body {
              font-family: Arial, sans-serif;
              max-width: 800px;
              margin: 0 auto;
              padding: 20px;
            }
            .download-btn {
              display: inline-block;
              background: #4CAF50;
              color: white;
              padding: 10px 20px;
              text-decoration: none;
              border-radius: 4px;
            }
          </style>
        </head>
        <body>
          <h1>App Downloads</h1>
          <p><a class="download-btn" href="downloads/app-release.apk">Download Android APK</a></p>
          <p>Last updated: $(date)</p>
        </body>
      </html>
      EOL
  artifacts:
    paths:
      - public
    expire_in: 30 days
  only:
    - main
  dependencies:
    - build_android
  needs:
    - build_android



